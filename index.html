<!DOCTYPE html>
<html>
<head>
  <title>Campus Navigator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
  #map-wrapper {
   margin-top: 10px;
   width: 100%;
   height: 600px;           /* Limit height of the container */
   overflow-y: auto;        /* Enable vertical scroll */
   overflow-x: auto;        
}

  #map-container {
   position: relative;
   display: inline-block;
   transform-origin: 0 0;
}

  #campus-map {
   max-width: none;
   width: 1000px; 
}

  #highlight {
   position: absolute;
   width: 20px;
   height: 20px;
   background-color: rgba(233, 229, 8, 0.45);
   border-radius: 50%;
   display: none;
   transform: translate(-50%, -50%);
   pointer-events: none;
}

  </style>
</head>
<a href="https://www.kpu.ca" target="_blank">
  <img src="KPU_logo.png" alt="KPU Logo" class="logo">
</a>
<body>

  <h1>Campus Navigator</h1>

  <a href="https://www.kpu.ca/surrey" target="_blank" id="info-button">
    For more information →
  </a>

  <a href="https://one.kpu.ca/" target="_blank" id="one_KPU-button">
    ONE.KPU→
  </a>

  <div id="floor-and-search">
  <div id="floor-buttons">
    <button onclick="setFloor(1)">Floor 1</button>
    <button onclick="setFloor(2)">Floor 2</button>
    <button onclick="setFloor(3)">Floor 3</button>
  </div>

  <div id="search-and-result">
    <div id="search-bar">
      <input type="text" id="courseInput" placeholder="Enter Course Code">
      <button onclick="search()">Search</button>
    </div>
    
    <div id="result"></div> 
  </div>
</div>

  <!-- Campus map with highlight -->
  <div id="map-wrapper">
  <div id="map-container">
    <img src="kpufloor1.png" id="campus-map" alt="Campus Map">
    <div id="highlight"></div>
  </div>
</div>

  <script>
    // Room-to-coordinate mapping 
    const roomCoordinates = {
      "103": { top: 3127, left: 4145 },
      "218": { top: 715, left: 2245},
      "1040": { top: 2340, left: 4578},
      "1045": { top: 2340, left: 4463},
      "1050": { top: 2340, left: 4347},
      "2040": { top: 2340, left: 4473 },
      "2050": { top: 2300, left: 4280 },
      "2065": { top: 2383, left: 4129},
      "2075": { top: 2383, left: 4015}
      
    };

    // Highlight room for selected course
    function highlightRoom(roomCode) {
  const highlight = document.getElementById('highlight');
  const coords = roomCoordinates[roomCode];

  if (coords) {
    const mapImg = document.getElementById('campus-map');

    // Get the natural image size and current displayed size
    const naturalWidth = mapImg.naturalWidth;
    const naturalHeight = mapImg.naturalHeight;
    const displayedWidth = mapImg.clientWidth;
    const displayedHeight = mapImg.clientHeight;

    // Calculate scale factors
    const scaleX = displayedWidth / naturalWidth;
    const scaleY = displayedHeight / naturalHeight;

    // Scale the coordinates
    const scaledTop = coords.top * scaleY;
    const scaledLeft = coords.left * scaleX;

    highlight.style.top = scaledTop + 'px';
    highlight.style.left = scaledLeft + 'px';
    highlight.style.display = 'block';
  } else {
    highlight.style.display = 'none';
  }
}


    async function search() {
  const course = document.getElementById('courseInput').value;
  const query = `
    query {
      getLocation(course: "${course}") {
        course
        building
        room
        hours
        occupancy
      }
    }
  `;

  
  const response = await fetch("http://localhost:4000/graphql", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ query })
  });

  const result = await response.json();
  const location = result.data.getLocation;

  if (location) {
    document.getElementById('result').innerHTML = `
      <span><strong>Course:</strong> ${location.course}</span>
      <span><strong>Location:</strong> ${location.building} ${location.room}</span>
      <span><strong>Hours:</strong> ${location.hours}</span>
      <span><strong>Occupancy:</strong> ${location.occupancy}</span>
    `;

    // Automatically switch floor based on first digit of room number
    const firstDigit = parseInt(location.room[0], 10);
    if ([1, 2, 3].includes(firstDigit)) {
      setFloor(firstDigit);
    }

    // Delay highlighting to let image update
    setTimeout(() => {
      highlightRoom(location.room);
    }, 50);
  } else {
    document.getElementById('result').innerHTML = `<p>No result found.</p>`;
    document.getElementById('highlight').style.display = 'none';
  }
}


// Implement scroll zoom
let scale = 1;
const container = document.getElementById('map-container');
const wrapper = document.getElementById('map-wrapper');

wrapper.addEventListener('wheel', function (e) {
  e.preventDefault();

  const zoomFactor = 0.1;
  const oldScale = scale;
  const zoomIn = e.deltaY < 0;
  scale += zoomIn ? zoomFactor : -zoomFactor;
  scale = Math.max(1, Math.min(scale, 5));

  // Coordinates relative to the container
  const rect = container.getBoundingClientRect();
  const dx = e.clientX - rect.left;
  const dy = e.clientY - rect.top;

  // Coordinates as a fraction of container
  const xRatio = dx / rect.width;
  const yRatio = dy / rect.height;

  // Applying scale
  container.style.transformOrigin = "0 0";
  container.style.transform = `scale(${scale})`;

  // Maintain scroll position so that zoom centers on mouse
  const scrollLeft = (container.offsetWidth * scale * xRatio) - wrapper.clientWidth / 2;
  const scrollTop = (container.offsetHeight * scale * yRatio) - wrapper.clientHeight / 2;

  wrapper.scrollLeft = scrollLeft;
  wrapper.scrollTop = scrollTop;
});

// Implement pinch zoom for mobile
let pinchStartDistance = null;
let initialScale = scale;

wrapper.addEventListener("touchstart", function (e) {
  if (e.touches.length === 2) {
    pinchStartDistance = getPinchDistance(e.touches[0], e.touches[1]);
    initialScale = scale;
  }
}, { passive: false });

wrapper.addEventListener("touchmove", function (e) {
  if (e.touches.length === 2 && pinchStartDistance !== null) {
    e.preventDefault();
    const newDistance = getPinchDistance(e.touches[0], e.touches[1]);
    const zoomFactor = newDistance / pinchStartDistance;
    scale = Math.max(1, Math.min(initialScale * zoomFactor, 5));

    container.style.transformOrigin = "0 0";
    container.style.transform = `scale(${scale})`;
  }
}, { passive: false });

wrapper.addEventListener("touchend", function (e) {
  if (e.touches.length < 2) {
    pinchStartDistance = null;
  }
}, { passive: false });

function getPinchDistance(touch1, touch2) {
  const dx = touch2.clientX - touch1.clientX;
  const dy = touch2.clientY - touch1.clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

// Have map image change based on user selected floor (default floor 1)
let currentFloor = 1;

    function setFloor(floor) {
      currentFloor = floor;
      const mapImg = document.getElementById('campus-map');

      // Change image source based on floor
      mapImg.src = `kpufloor${floor}.png`;

      // Reset zoom scale and transform
      scale = 1;
      const container = document.getElementById('map-container');
      container.style.transform = `scale(${scale})`;
      container.style.transformOrigin = '0 0';

      // Reset scroll positions
      const wrapper = document.getElementById('map-wrapper');
      wrapper.scrollLeft = 0;
      wrapper.scrollTop = 0;

      // Hide highlight on floor change 
      document.getElementById('highlight').style.display = 'none';

    }

    // Set initial floor
    setFloor(1);
    
  </script>

  <script>
  window.addEventListener('load', () => {
    const map = document.getElementById('campus-map');
    const container = document.getElementById('map-container');

    if (!map.complete) {
      map.onload = () => {
        container.style.maxHeight = map.clientHeight + 'px';
        container.style.maxWidth = map.clientWidth + 'px';
      };
    } else {
      container.style.maxHeight = map.clientHeight + 'px';
      container.style.maxWidth = map.clientWidth + 'px';
    }
  });
</script>
</body>
</html>
